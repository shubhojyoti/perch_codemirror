(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("../xml/xml"),require("../meta"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../xml/xml","../meta"],a)}else{a(CodeMirror)}}})(function(a){a.defineMode("markdown",function(E,n){var j=a.getMode(E,"text/html");var d=j.name=="null";function f(I){if(a.findModeByName){var J=a.findModeByName(I);if(J){I=J.mime||J.mimes[0]}}var K=a.getMode(E,I);return K.name=="null"?null:K}if(n.highlightFormatting===undefined){n.highlightFormatting=false}if(n.maxBlockquoteDepth===undefined){n.maxBlockquoteDepth=0}if(n.underscoresBreakWords===undefined){n.underscoresBreakWords=true}if(n.taskLists===undefined){n.taskLists=false}if(n.strikethrough===undefined){n.strikethrough=false}if(n.tokenTypeOverrides===undefined){n.tokenTypeOverrides={}}var p={header:"header",code:"comment",quote:"quote",list1:"variable-2",list2:"variable-3",list3:"keyword",hr:"hr",image:"image",imageAltText:"image-alt-text",imageMarker:"image-marker",formatting:"formatting",linkInline:"link",linkEmail:"link",linkText:"link",linkHref:"string",em:"em",strong:"strong",strikethrough:"strikethrough"};for(var G in p){if(p.hasOwnProperty(G)&&n.tokenTypeOverrides[G]){p[G]=n.tokenTypeOverrides[G]}}var H=/^([*\-_])(?:\s*\1){2,}\s*$/,y=/^(?:[*\-+]|^[0-9]+([.)]))\s+/,B=/^\[(x| )\](?=\s)/,o=n.allowAtxHeaderWithoutSpace?/^(#+)/:/^(#+)(?: |$)/,D=/^ *(?:\={1,}|-{1,})\s*$/,h=/^[^#!\[\]*_\\<>` "'(~]+/,C=new RegExp("^("+(n.fencedCodeBlocks===true?"~~~+|```+":n.fencedCodeBlocks)+")[ \\t]*([\\w+#-]*)");function g(K,J,I){J.f=J.inline=I;return I(K,J)}function u(K,J,I){J.f=J.block=I;return I(K,J)}function s(I){return !I||!/\S/.test(I.string)}function r(I){I.linkTitle=false;I.em=false;I.strong=false;I.strikethrough=false;I.quote=0;I.indentedCode=false;if(d&&I.f==x){I.f=t;I.block=m}I.trailingSpace=0;I.trailingSpaceNewLine=false;I.prevLine=I.thisLine;I.thisLine=null;return null}function m(O,N){var M=O.sol();var K=N.list!==false,I=N.indentedCode;N.indentedCode=false;if(K){if(N.indentationDiff>=0){if(N.indentationDiff<4){N.indentation-=N.indentationDiff}N.list=null}else{if(N.indentation>0){N.list=null}else{N.list=false}}}var J=null;if(N.indentationDiff>=4){O.skipToEnd();if(I||s(N.prevLine)){N.indentation-=4;N.indentedCode=true;return p.code}else{return null}}else{if(O.eatSpace()){return null}else{if((J=O.match(o))&&J[1].length<=6){N.header=J[1].length;if(n.highlightFormatting){N.formatting="header"}N.f=N.inline;return w(N)}else{if(!s(N.prevLine)&&!N.quote&&!K&&!I&&(J=O.match(D))){N.header=J[0].charAt(0)=="="?1:2;if(n.highlightFormatting){N.formatting="header"}N.f=N.inline;return w(N)}else{if(O.eat(">")){N.quote=M?1:N.quote+1;if(n.highlightFormatting){N.formatting="quote"}O.eatSpace();return w(N)}else{if(O.peek()==="["){return g(O,N,l)}else{if(O.match(H,true)){N.hr=true;return p.hr}else{if(J=O.match(y)){var L=J[1]?"ol":"ul";N.indentation=O.column()+O.current().length;N.list=true;while(N.listStack&&O.column()<N.listStack[N.listStack.length-1]){N.listStack.pop()}N.listStack.push(N.indentation);if(n.taskLists&&O.match(B,false)){N.taskList=true}N.f=N.inline;if(n.highlightFormatting){N.formatting=["list","list-"+L]}return w(N)}else{if(n.fencedCodeBlocks&&(J=O.match(C,true))){N.fencedChars=J[1];N.localMode=f(J[2]);if(N.localMode){N.localState=a.startState(N.localMode)}N.f=N.block=v;if(n.highlightFormatting){N.formatting="code-block"}N.code=-1;return w(N)}}}}}}}}}return g(O,N,N.inline)}function x(L,K){var J=j.token(L,K.htmlState);if(!d){var I=a.innerMode(j,K.htmlState);if((I.mode.name=="xml"&&I.state.tagStart===null&&(!I.state.context&&I.state.tokenize.isInText))||(K.md_inside&&L.current().indexOf(">")>-1)){K.f=t;K.block=m;K.htmlState=null}}return J}function v(J,I){if(I.fencedChars&&J.match(I.fencedChars,false)){I.localMode=I.localState=null;I.f=I.block=z;return null}else{if(I.localMode){return I.localMode.token(J,I.localState)}else{J.skipToEnd();return p.code}}}function z(K,J){K.match(J.fencedChars);J.block=m;J.f=t;J.fencedChars=null;if(n.highlightFormatting){J.formatting="code-block"}J.code=1;var I=w(J);J.code=0;return I}function w(L){var K=[];if(L.formatting){K.push(p.formatting);if(typeof L.formatting==="string"){L.formatting=[L.formatting]}for(var I=0;I<L.formatting.length;I++){K.push(p.formatting+"-"+L.formatting[I]);if(L.formatting[I]==="header"){K.push(p.formatting+"-"+L.formatting[I]+"-"+L.header)}if(L.formatting[I]==="quote"){if(!n.maxBlockquoteDepth||n.maxBlockquoteDepth>=L.quote){K.push(p.formatting+"-"+L.formatting[I]+"-"+L.quote)}else{K.push("error")}}}}if(L.taskOpen){K.push("meta");return K.length?K.join(" "):null}if(L.taskClosed){K.push("property");return K.length?K.join(" "):null}if(L.linkHref){K.push(p.linkHref,"url")}else{if(L.strong){K.push(p.strong)}if(L.em){K.push(p.em)}if(L.strikethrough){K.push(p.strikethrough)}if(L.linkText){K.push(p.linkText)}if(L.code){K.push(p.code)}if(L.image){K.push(p.image)}if(L.imageAltText){K.push(p.imageAltText,"link")}if(L.imageMarker){K.push(p.imageMarker)}}if(L.header){K.push(p.header,p.header+"-"+L.header)}if(L.quote){K.push(p.quote);if(!n.maxBlockquoteDepth||n.maxBlockquoteDepth>=L.quote){K.push(p.quote+"-"+L.quote)}else{K.push(p.quote+"-"+n.maxBlockquoteDepth)}}if(L.list!==false){var J=(L.listStack.length-1)%3;if(!J){K.push(p.list1)}else{if(J===1){K.push(p.list2)}else{K.push(p.list3)}}}if(L.trailingSpaceNewLine){K.push("trailing-space-new-line")}else{if(L.trailingSpace){K.push("trailing-space-"+(L.trailingSpace%2?"a":"b"))}}return K.length?K.join(" "):null}function c(J,I){if(J.match(h,true)){return w(I)}return undefined}function t(N,M){var Y=M.text(N,M);if(typeof Y!=="undefined"){return Y}if(M.list){M.list=null;return w(M)}if(M.taskList){var U=N.match(B,true)[1]!=="x";if(U){M.taskOpen=true}else{M.taskClosed=true}if(n.highlightFormatting){M.formatting="task"}M.taskList=false;return w(M)}M.taskOpen=false;M.taskClosed=false;if(M.header&&N.match(/^#+$/,true)){if(n.highlightFormatting){M.formatting="header"}return w(M)}var I=N.sol();var S=N.next();if(M.linkTitle){M.linkTitle=false;var X=S;if(S==="("){X=")"}X=(X+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var J="^\\s*(?:[^"+X+"\\\\]+|\\\\\\\\|\\\\.)"+X;if(N.match(new RegExp(J),true)){return p.linkHref}}if(S==="`"){var W=M.formatting;if(n.highlightFormatting){M.formatting="code"}N.eatWhile("`");var P=N.current().length;if(M.code==0){M.code=P;return w(M)}else{if(P==M.code){var T=w(M);M.code=0;return T}else{M.formatting=W;return w(M)}}}else{if(M.code){return w(M)}}if(S==="\\"){N.next();if(n.highlightFormatting){var K=w(M);var R=p.formatting+"-escape";return K?K+" "+R:R}}if(S==="!"&&N.match(/\[[^\]]*\] ?(?:\(|\[)/,false)){M.imageMarker=true;M.image=true;if(n.highlightFormatting){M.formatting="image"}return w(M)}if(S==="["&&M.imageMarker&&N.match(/[^\]]*\](\(.*?\)| ?\[.*?\])/,false)){M.imageMarker=false;M.imageAltText=true;if(n.highlightFormatting){M.formatting="image"}return w(M)}if(S==="]"&&M.imageAltText){if(n.highlightFormatting){M.formatting="image"}var K=w(M);M.imageAltText=false;M.image=false;M.inline=M.f=i;return K}if(S==="["&&N.match(/[^\]]*\](\(.*\)| ?\[.*?\])/,false)&&!M.image){M.linkText=true;if(n.highlightFormatting){M.formatting="link"}return w(M)}if(S==="]"&&M.linkText&&N.match(/\(.*?\)| ?\[.*?\]/,false)){if(n.highlightFormatting){M.formatting="link"}var K=w(M);M.linkText=false;M.inline=M.f=i;return K}if(S==="<"&&N.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,false)){M.f=M.inline=A;if(n.highlightFormatting){M.formatting="link"}var K=w(M);if(K){K+=" "}else{K=""}return K+p.linkInline}if(S==="<"&&N.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,false)){M.f=M.inline=A;if(n.highlightFormatting){M.formatting="link"}var K=w(M);if(K){K+=" "}else{K=""}return K+p.linkEmail}if(S==="<"&&N.match(/^(!--|[a-z]+(?:\s+[a-z_:.\-]+(?:\s*=\s*[^ >]+)?)*\s*>)/i,false)){var L=N.string.indexOf(">",N.pos);if(L!=-1){var V=N.string.substring(N.start,L);if(/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(V)){M.md_inside=true}}N.backUp(1);M.htmlState=a.startState(j);return u(N,M,x)}if(S==="<"&&N.match(/^\/\w*?>/)){M.md_inside=false;return"tag"}var Q=false;if(!n.underscoresBreakWords){if(S==="_"&&N.peek()!=="_"&&N.match(/(\w)/,false)){var O=N.pos-2;if(O>=0){var Z=N.string.charAt(O);if(Z!=="_"&&Z.match(/(\w)/,false)){Q=true}}}}if(S==="*"||(S==="_"&&!Q)){if(I&&N.peek()===" "){}else{if(M.strong===S&&N.eat(S)){if(n.highlightFormatting){M.formatting="strong"}var T=w(M);M.strong=false;return T}else{if(!M.strong&&N.eat(S)){M.strong=S;if(n.highlightFormatting){M.formatting="strong"}return w(M)}else{if(M.em===S){if(n.highlightFormatting){M.formatting="em"}var T=w(M);M.em=false;return T}else{if(!M.em){M.em=S;if(n.highlightFormatting){M.formatting="em"}return w(M)}}}}}}else{if(S===" "){if(N.eat("*")||N.eat("_")){if(N.peek()===" "){return w(M)}else{N.backUp(1)}}}}if(n.strikethrough){if(S==="~"&&N.eatWhile(S)){if(M.strikethrough){if(n.highlightFormatting){M.formatting="strikethrough"}var T=w(M);M.strikethrough=false;return T}else{if(N.match(/^[^\s]/,false)){M.strikethrough=true;if(n.highlightFormatting){M.formatting="strikethrough"}return w(M)}}}else{if(S===" "){if(N.match(/^~~/,true)){if(N.peek()===" "){return w(M)}else{N.backUp(2)}}}}}if(S===" "){if(N.match(/ +$/,false)){M.trailingSpace++}else{if(M.trailingSpace){M.trailingSpaceNewLine=true}}}return w(M)}function A(L,K){var J=L.next();if(J===">"){K.f=K.inline=t;if(n.highlightFormatting){K.formatting="link"}var I=w(K);if(I){I+=" "}else{I=""}return I+p.linkInline}L.match(/^[^>]+/,true);return p.linkInline}function i(K,J){if(K.eatSpace()){return null}var I=K.next();if(I==="("||I==="["){J.f=J.inline=k(I==="("?")":"]",0);if(n.highlightFormatting){J.formatting="link-string"}J.linkHref=true;return w(J)}return"error"}var e={")":/^(?:[^\\\(\)]|\\.|\((?:[^\\\(\)]|\\.)*\))*?(?=\))/,"]":/^(?:[^\\\[\]]|\\.|\[(?:[^\\\[\\]]|\\.)*\])*?(?=\])/};function k(I){return function(M,L){var K=M.next();if(K===I){L.f=L.inline=t;if(n.highlightFormatting){L.formatting="link-string"}var J=w(L);L.linkHref=false;return J}M.match(e[I]);L.linkHref=true;return w(L)}}function l(J,I){if(J.match(/^([^\]\\]|\\.)*\]:/,false)){I.f=F;J.next();if(n.highlightFormatting){I.formatting="link"}I.linkText=true;return w(I)}return g(J,I,t)}function F(K,J){if(K.match(/^\]:/,true)){J.f=J.inline=b;if(n.highlightFormatting){J.formatting="link"}var I=w(J);J.linkText=false;return I}K.match(/^([^\]\\]|\\.)+/,true);return p.linkText}function b(J,I){if(J.eatSpace()){return null}J.match(/^[^\s]+/,true);if(J.peek()===undefined){I.linkTitle=true}else{J.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,true)}I.f=I.inline=t;return p.linkHref+" url"}var q={startState:function(){return{f:m,prevLine:null,thisLine:null,block:m,htmlState:null,indentation:0,inline:t,text:c,formatting:false,linkText:false,linkHref:false,linkTitle:false,code:0,em:false,strong:false,header:0,hr:false,taskList:false,list:false,listStack:[],quote:0,trailingSpace:0,trailingSpaceNewLine:false,strikethrough:false,fencedChars:null}},copyState:function(I){return{f:I.f,prevLine:I.prevLine,thisLine:I.thisLine,block:I.block,htmlState:I.htmlState&&a.copyState(j,I.htmlState),indentation:I.indentation,localMode:I.localMode,localState:I.localMode?a.copyState(I.localMode,I.localState):null,inline:I.inline,text:I.text,formatting:false,linkTitle:I.linkTitle,code:I.code,em:I.em,strong:I.strong,strikethrough:I.strikethrough,header:I.header,hr:I.hr,taskList:I.taskList,list:I.list,listStack:I.listStack.slice(0),quote:I.quote,indentedCode:I.indentedCode,trailingSpace:I.trailingSpace,trailingSpaceNewLine:I.trailingSpaceNewLine,md_inside:I.md_inside,fencedChars:I.fencedChars}},token:function(L,K){K.formatting=false;if(L!=K.thisLine){var I=K.header||K.hr;K.header=0;K.hr=false;if(L.match(/^\s*$/,true)||I){r(K);if(!I){return null}K.prevLine=null}K.prevLine=K.thisLine;K.thisLine=L;K.taskList=false;K.trailingSpace=0;K.trailingSpaceNewLine=false;K.f=K.block;var J=L.match(/^\s*/,true)[0].replace(/\t/g,"    ").length;K.indentationDiff=Math.min(J-K.indentation,4);K.indentation=K.indentation+K.indentationDiff;if(J>0){return null}}return K.f(L,K)},innerMode:function(I){if(I.block==x){return{state:I.htmlState,mode:j}}if(I.localState){return{state:I.localState,mode:I.localMode}}return{state:I,mode:q}},blankLine:r,getType:w,closeBrackets:"()[]{}''\"\"``",fold:"markdown"};return q},"xml");a.defineMIME("text/x-markdown","markdown")});